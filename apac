



// C:\Users\W0024618\Desktop\swipeData\employee-ai-insights\controllers\liveOccupancyController.js
const { DateTime } = require('luxon');
const { sql, getPool } = require('../config/db');

const doorZoneMap  = require('../data/doorZoneMap');
const zoneFloorMap = require('../data/zoneFloorMap');
const ertMembers   = require('../data/puneErtMembers.json');

// Track which door‚Üízone keys we've already warned on
const warnedKeys = new Set();

// --- Helpers ---

function getTodayString() {
  return DateTime.now().setZone('Asia/Kolkata').toFormat('yyyy-LL-dd');
}

function normalizeZoneKey(rawDoor, rawDir) {
  let door = String(rawDoor || '').trim();
  door = door.replace(/_[0-9A-F]{2}:[0-9A-F]{2}:[0-9A-F]{2}$/, '');
  door = door.replace(/\s+/g, ' ').toUpperCase();
  const dir = rawDir === 'InDirection' ? 'InDirection' : 'OutDirection';
  return `${door}___${dir}`;
}

function normalizePersonName(raw) {
  let n = String(raw || '').trim();
  if (n.includes(',')) {
    const [last, rest] = n.split(',', 2);
    n = `${rest.trim()} ${last.trim()}`;
  }
  return n.toLowerCase();
}

function mapDoorToZone(rawDoor, rawDir) {
  const key = normalizeZoneKey(rawDoor, rawDir);
  const zone = doorZoneMap[key];
  if (!zone) {
    if (!warnedKeys.has(key)) {
      console.warn('‚õî Unmapped door‚Äìdirection key:', key);
      warnedKeys.add(key);
    }
    return 'Unknown Zone';
  }
  return zone;
}

// --- Core functions ---

async function fetchNewEvents(since) {
  const pool = await getPool();
  const req  = pool.request();
  req.input('since', sql.DateTime2, since);

  const { recordset } = await req.query(`
    WITH CombinedQuery AS (
      SELECT
        DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) AS LocaleMessageTime,
        t1.ObjectName1,
        CASE
          WHEN t3.Name IN ('Contractor','Terminated Contractor') THEN t2.Text12
          ELSE CAST(t2.Int1 AS NVARCHAR)
        END AS EmployeeID,
        t1.ObjectIdentity1 AS PersonGUID,
        t3.Name AS PersonnelType,
        COALESCE(
          TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID/Card)[1]','varchar(50)'),
          TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID)[1]','varchar(50)'),
          sc.value
        ) AS CardNumber,
        t5a.value AS AdmitCode,
        t5d.value AS Direction,
        t1.ObjectName2 AS Door,
        t2.Text4 AS CompanyName,          -- ‚úÖ added
      t2.Text5 AS PrimaryLocation       -- ‚úÖ added
      FROM [ACVSUJournal_00010030].[dbo].[ACVSUJournalLog] t1
      LEFT JOIN [ACVSCore].[Access].[Personnel] t2 ON t1.ObjectIdentity1 = t2.GUID
      LEFT JOIN [ACVSCore].[Access].[PersonnelType] t3 ON t2.PersonnelTypeId = t3.ObjectID
      LEFT JOIN [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxmlShred] t5a
        ON t1.XmlGUID = t5a.GUID AND t5a.Name = 'AdmitCode'
      LEFT JOIN [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxmlShred] t5d
        ON t1.XmlGUID = t5d.GUID AND t5d.Value IN ('InDirection','OutDirection')
      LEFT JOIN [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxml] t_xml
        ON t1.XmlGUID = t_xml.GUID
      LEFT JOIN (
        SELECT GUID, value
        FROM [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxmlShred]
        WHERE Name IN ('Card','CHUID')
      ) sc ON t1.XmlGUID = sc.GUID
      WHERE
        t1.MessageType = 'CardAdmitted'
        AND t1.PartitionName2 = 'APAC.Default'
        AND DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) > @since
    )
    SELECT
      LocaleMessageTime,
      CONVERT(VARCHAR(10), LocaleMessageTime, 23) AS Dateonly,
      CONVERT(VARCHAR(8), LocaleMessageTime, 108) AS Swipe_Time,
      EmployeeID,
      PersonGUID,
      ObjectName1,
      PersonnelType,
      CardNumber,
      AdmitCode,
      Direction,
      Door,
      CompanyName,         -- ‚úÖ 
      PrimaryLocation      -- ‚úÖ 
    FROM CombinedQuery
    ORDER BY LocaleMessageTime ASC;
  `);

  return recordset;
}

async function buildOccupancy(allEvents) {
  const current      = {};
  const uniquePeople = new Map();

  for (const evt of allEvents) {
    const {
      EmployeeID, PersonGUID,
      ObjectName1, PersonnelType,
      CardNumber, Dateonly,
      Swipe_Time, Direction, Door
    } = evt;

    const dedupKey = PersonGUID || EmployeeID || CardNumber || ObjectName1;
    const zoneRaw  = mapDoorToZone(Door, Direction);

    if (zoneRaw === 'Unknown Zone') continue;

    const zoneLower = zoneRaw.toLowerCase();

    if (Direction === 'OutDirection') {
      if (zoneLower === 'out of office') {
        uniquePeople.delete(dedupKey);
        delete current[dedupKey];
      } else {
        uniquePeople.set(dedupKey, PersonnelType);
        current[dedupKey] = { Dateonly, Swipe_Time, EmployeeID, ObjectName1, CardNumber, PersonnelType, zone: zoneRaw, door: Door, CompanyName: evt.CompanyName || null,  PrimaryLocation: evt.PrimaryLocation || null  };
      }
      continue;
    }

    if (Direction === 'InDirection') {
      uniquePeople.set(dedupKey, PersonnelType);
      current[dedupKey] = { Dateonly, Swipe_Time, EmployeeID, ObjectName1, CardNumber, PersonnelType, zone: zoneRaw, door: Door, Direction,CompanyName: evt.CompanyName || null, PrimaryLocation: evt.PrimaryLocation || null  };
      continue;
    }

    uniquePeople.delete(dedupKey);
    delete current[dedupKey];
  }

  let employeeCount = 0;
  let contractorCount = 0;
  for (const pt of uniquePeople.values()) {
    if (['Employee','Terminated Personnel'].includes(pt)) employeeCount++;
    else contractorCount++;
  }

  const zoneMap = {};
  for (const emp of Object.values(current)) {
    const zKey = emp.zone.toLowerCase();
    if (zKey === 'out of office') continue;
    zoneMap[emp.zone] = zoneMap[emp.zone] || [];
    zoneMap[emp.zone].push(emp);
  }

  const zoneDetails = Object.fromEntries(
    Object.entries(zoneMap).map(([zone, emps]) => {
      const byType = emps.reduce((acc, e) => {
        acc[e.PersonnelType] = (acc[e.PersonnelType] || 0) + 1;
        return acc;
      }, {});
      return [zone, { total: emps.length, byPersonnelType: byType, employees: emps }];
    })
  );

  const floorMap = {};
  for (const [zone, data] of Object.entries(zoneDetails)) {
    const floor = zoneFloorMap[zone] || 'Unknown Floor';
    floorMap[floor] = floorMap[floor] || { total: 0, byPersonnelType: {} };
    floorMap[floor].total += data.total;
    for (const [pt, c] of Object.entries(data.byPersonnelType)) {
      floorMap[floor].byPersonnelType[pt] = (floorMap[floor].byPersonnelType[pt] || 0) + c;
    }
  }

  const ertStatus = Object.fromEntries(
    Object.entries(ertMembers).map(([role, members]) => {
      const list = members.map(m => {
        const rawName = m.name || m.Name;
        const expected = normalizePersonName(rawName);
        const matchEvt = Object.values(current).find(e => normalizePersonName(e.ObjectName1) === expected);
        return { ...m, present: !!matchEvt, zone: matchEvt ? matchEvt.zone : null };
      });
      return [role, list];
    })
  );

  return {
    asOf: new Date().toISOString(),
    summary: Object.entries(zoneDetails).map(([z,d])=>({ zone: z, count: d.total })),
    zoneBreakdown: Object.entries(zoneDetails).map(([z,d])=>({ zone: z, ...d.byPersonnelType, total: d.total })),
    floorBreakdown: Object.entries(floorMap).map(([f,d])=>({ floor: f, ...d.byPersonnelType, total: d.total })),
    details: zoneMap,
    personnelSummary: { employees: employeeCount, contractors: contractorCount },
    ertStatus,
    personnelBreakdown: (() => {
      const map = new Map();
      for (const pt of uniquePeople.values()) map.set(pt, (map.get(pt)||0)+1);
      return Array.from(map, ([personnelType, count]) => ({ personnelType, count }));
    })()
  };
}

function buildVisitedToday(allEvents, asOf) {
  let today;
  if (asOf) {
    if (typeof asOf === 'string') today = asOf;
    else if (asOf instanceof Date) today = DateTime.fromJSDate(asOf, { zone: 'Asia/Kolkata' }).toFormat('yyyy-LL-dd');
    else if (asOf && typeof asOf.toFormat === 'function') today = asOf.setZone('Asia/Kolkata').toFormat('yyyy-LL-dd');
    else today = DateTime.now().setZone('Asia/Kolkata').toFormat('yyyy-LL-dd');
  } else today = DateTime.now().setZone('Asia/Kolkata').toFormat('yyyy-LL-dd');

  const todayIns = allEvents.filter(evt => evt.Direction === 'InDirection' && evt.Dateonly === today);
  const dedup = new Map();
  for (const e of todayIns) {
    const key = e.PersonGUID;
    const prev = dedup.get(key);
    if (!prev || e.LocaleMessageTime > prev.LocaleMessageTime) dedup.set(key, e);
  }
  const finalList = Array.from(dedup.values());
  const employees = finalList.filter(e => !['Contractor','Terminated Contractor','Temp Badge','Visitor','Property Management'].includes(e.PersonnelType)).length;
  const contractors = finalList.length - employees;
  return { employees, contractors, total: finalList.length };
}


// --- SSE endpoint ---


exports.getLiveOccupancy = async (req, res) => {
  try {
    await getPool();

    res.writeHead(200, {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    });
    res.write('\n');

    let lastSeen = new Date();
    const events = [];

    const push = async () => {
      // fetch only new events since lastSeen
      const fresh = await fetchNewEvents(lastSeen);
      if (fresh.length) {
        lastSeen = new Date();
        events.push(...fresh);
      }

      // build live snapshot
      const occupancy = await buildOccupancy(events);
      const todayStats = buildVisitedToday(events);
      occupancy.totalVisitedToday = todayStats.total;
      occupancy.visitedToday = { ...todayStats };

      // send snapshot every second
      const sid = Date.now();
      res.write(`id: ${sid}\n`);
      res.write(`data: ${JSON.stringify(occupancy)}\n\n`);

      if (typeof res.flush === 'function') res.flush();
    };

    // push immediately, then every 1 second
    await push();
    const timer = setInterval(push, 1000);

    req.on('close', () => clearInterval(timer));
  } catch (err) {
    console.error('Live occupancy SSE error:', err);
    if (!res.headersSent) {
      res.status(500).json({ error: 'Internal Server Error' });
    }
  }
};




// GET /api/occupancy-at-time-pune?date=YYYY-MM-DD&time=HH:MM[:SS]
exports.getPuneSnapshotAtDateTime = async (req, res) => {
  try {
    const { date, time } = req.query;
    if (!date || !time) {
      return res.status(400).json({
        error: 'missing query params: expected ?date=YYYY-MM-DD&time=HH:MM[:SS]'
      });
    }

    // Validate date
    const dateMatch = /^(\d{4})-(\d{2})-(\d{2})$/.exec(date);
    if (!dateMatch) {
      return res.status(400).json({ error: 'invalid "date" format; expected YYYY-MM-DD' });
    }

    // Validate time
    const timeMatch = /^([0-1]\d|2[0-3]):([0-5]\d)(?::([0-5]\d))?$/.exec(time);
    if (!timeMatch) {
      return res.status(400).json({ error: 'invalid "time" format; expected HH:MM or HH:MM:SS' });
    }

    const year   = Number(dateMatch[1]);
    const month  = Number(dateMatch[2]);
    const day    = Number(dateMatch[3]);
    const hour   = Number(timeMatch[1]);
    const minute = Number(timeMatch[2]);
    const second = timeMatch[3] ? Number(timeMatch[3]) : 0;

    // Build Pune-local datetime
    const atDt = DateTime.fromObject(
      { year, month, day, hour, minute, second, millisecond: 0 },
      { zone: 'Asia/Kolkata' }
    );

    if (!atDt.isValid) {
      return res.status(400).json({ error: 'invalid date+time combination' });
    }

    // Convert to UTC for SQL boundary
    const untilUtc = atDt.setZone('utc').toJSDate();

    // -----------------
    // Step 1: fetch events in 24h window ending at atDt
    const pool = await getPool();
    const reqDb = pool.request();
    reqDb.input('until', sql.DateTime2, untilUtc);

    const { recordset } = await reqDb.query(`
      WITH CombinedQuery AS (
        SELECT
          t1.MessageUTC,   -- always UTC
          t1.ObjectName1,
          CASE
            WHEN t3.Name IN ('Contractor','Terminated Contractor') THEN t2.Text12
            ELSE CAST(t2.Int1 AS NVARCHAR)
          END AS EmployeeID,
          t1.ObjectIdentity1 AS PersonGUID,
          t3.Name AS PersonnelType,
          COALESCE(
            TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID/Card)[1]','varchar(50)'),
            TRY_CAST(t_xml.XmlMessage AS XML).value('(/LogMessage/CHUID)[1]','varchar(50)'),
            sc.value
          ) AS CardNumber,
          t5a.value AS AdmitCode,
          t5d.value AS Direction,
          t1.ObjectName2 AS Door,
           t2.Text4 AS CompanyName,          -- ‚úÖ added
           t2.Text5 AS PrimaryLocation       -- ‚úÖ added
        FROM [ACVSUJournal_00010030].[dbo].[ACVSUJournalLog] t1
        LEFT JOIN [ACVSCore].[Access].[Personnel]     t2 ON t1.ObjectIdentity1 = t2.GUID
        LEFT JOIN [ACVSCore].[Access].[PersonnelType] t3 ON t2.PersonnelTypeId = t3.ObjectID
        LEFT JOIN [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxmlShred] t5a
          ON t1.XmlGUID = t5a.GUID AND t5a.Name = 'AdmitCode'
        LEFT JOIN [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxmlShred] t5d
          ON t1.XmlGUID = t5d.GUID AND t5d.Value IN ('InDirection','OutDirection')
        LEFT JOIN [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxml] t_xml
          ON t1.XmlGUID = t_xml.GUID
        LEFT JOIN (
          SELECT GUID, value
          FROM [ACVSUJournal_00010030].[dbo].[ACVSUJournalLogxmlShred]
          WHERE Name IN ('Card','CHUID')
        ) sc ON t1.XmlGUID = sc.GUID
        WHERE
          t1.MessageType     = 'CardAdmitted'
          AND t1.PartitionName2 = 'APAC.Default'
          AND t1.MessageUTC <= @until
          AND DATEADD(HOUR, -24, @until) < t1.MessageUTC
      )
      SELECT *
      FROM CombinedQuery
      ORDER BY MessageUTC ASC;
    `);

    // -----------------
    // Step 2: convert UTC ‚Üí Asia/Kolkata
    const events = recordset.map(e => {
      const local = DateTime.fromJSDate(e.MessageUTC, { zone: 'utc' })
                            .setZone('Asia/Kolkata');
      return {
        ...e,
        LocaleMessageTime: local.toISO(),
        Dateonly: local.toFormat('yyyy-LL-dd'),
        Swipe_Time: local.toFormat('HH:mm:ss'),
      };
    });

    // -----------------
    // Step 3: filter only same Pune date
    const targetDate = atDt.toFormat('yyyy-LL-dd');
    const filtered = events.filter(e => e.Dateonly === targetDate);

    // Step 4: build occupancy snapshot
    const occupancy = await buildOccupancy(filtered);

    // Step 5: visited-today counts aligned to atDt
    // const visitedStats = buildVisitedToday(filtered);
    
    const visitedStats = buildVisitedToday(filtered, atDt);  // this add new code as per function buildVisitedToday change üìù üìù

    // ---- Output timestamps ----
    occupancy.asOfLocal = atDt.toISO(); // Pune-local with offset
    occupancy.asOfUTC   = `${date}T${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}:${String(second).padStart(2,'0')}Z`;

    occupancy.totalVisitedToday = visitedStats.total;
    occupancy.visitedToday = visitedStats;

    return res.json(occupancy);
  } catch (err) {
    console.error('getPuneSnapshotAtDateTime error:', err);
    return res.status(500).json({ error: 'Internal Server Error' });
  }
};












***************************************************
***************************************************





// C:\Users\W0024618\Desktop\swipeData\employee-ai-insights\routes\liveOccupancyRoutes.js
const express = require('express');
const router = express.Router();
const {
  getLiveOccupancy,
  getPuneSnapshotAtDateTime,
 
} = require('../controllers/liveOccupancyController');

router.get('/live-occupancy', getLiveOccupancy);

// New snapshot endpoint
router.get('/occupancy-at-time-pune', getPuneSnapshotAtDateTime);

module.exports = router;




***************************************************
***************************************************


// C:\Users\W0024618\Desktop\swipeData\employee-ai-insights\config\db.js
// config/db.js
require('dotenv').config();
const sql = require('mssql');

// Pull and trim environment variables
const DB_USER     = (process.env.DB_USER     || '').trim();
const DB_PASSWORD = (process.env.DB_PASSWORD || '').trim();
const DB_SERVER   = (process.env.DB_SERVER   || '').trim();
const DB_DATABASE = (process.env.DB_DATABASE || '').trim();
const DB_PORT     = parseInt((process.env.DB_PORT || '').trim(), 10) || 1433;

const dbConfig = {
  user: DB_USER,
  password: DB_PASSWORD,
  server: DB_SERVER,
  port: DB_PORT,
  database: DB_DATABASE,
  options: { 
    encrypt: true,               // for Azure / secure connections
    trustServerCertificate: true,
    enableArithAbort: true
  },
  pool: {
    max: 20,                      // tuneable
    min: 1,
    idleTimeoutMillis: 30000,
    acquireTimeoutMillis: 60000
  },
  requestTimeout: 1800000,       // 30 minutes
  connectionTimeout: 60000       // 1 minute
};

let poolPromise = null;

async function getPool(attempts = 5) {
  if (poolPromise) return poolPromise;

  poolPromise = (async () => {
    try {
      const pool = await sql.connect(dbConfig);
      console.log('‚úÖ MSSQL pool connected (Pune)');

      pool.on('error', err => {
        console.error('‚ùå MSSQL pool error (Pune):', err);
        poolPromise = null; // reset to allow reconnect
      });

      return pool;
    } catch (err) {
      console.error('‚ùå MSSQL pool connection failed (Pune):', err);
      poolPromise = null;
      if (attempts > 0) {
        console.log(`‚è≥ Retrying MSSQL connect (Pune) (${attempts} left)‚Ä¶`);
        await new Promise(res => setTimeout(res, 3000));
        return getPool(attempts - 1);
      }
      throw err;
    }
  })();

  // Global handler for MSSQL pool-level errors
  sql.on('error', err => {
    console.error('‚ùå MSSQL global error (Pune):', err);
    if (err && err.name === 'TimeoutError') poolPromise = null;
  });

  process.on('unhandledRejection', reason => {
    console.error('‚ùå Unhandled Rejection at (Pune):', reason);
  });

  process.on('uncaughtException', err => {
    console.error('‚ùå Uncaught Exception (will exit) (Pune):', err);
    // optional: process.exit(1);
  });

  return poolPromise;
}

module.exports = { sql, getPool };



***************************************************
***************************************************



// data/doorZoneMap.js


const doorZoneMap = {


  // Podium / Red
  "APAC_IN_PUN_PODIUM_RED_IDF ROOM-02-RESTRICTED DOOR___InDirection":                 "Red Zone",
  "APAC_IN_PUN_PODIUM_ST2 DOOR 1 (RED)___InDirection":                               "Red Zone",
  "APAC_IN_PUN_PODIUM_RED_MAIN LIFT LOBBY ENTRY 1-DOOR___InDirection":                 "Red Zone",
  "APAC_IN_PUN_PODIUM_RED_MAIN LIFT LOBBY ENTRY 1-DOOR___OutDirection":                "Out of office",
  "APAC_IN_PUN_PODIUM_ST 1-DOOR 1 (RED)___InDirection":                                "Red Zone",
  "APAC_IN_PUN_PODIUM_ST 1-DOOR 1 (RED)___OutDirection":                               "Red Zone",
  "APAC_IN_PUN_PODIUM_RED_RECEPTION TO WS ENTRY 1-DOOR NEW___InDirection":             "Red Zone",
  "APAC_IN_PUN_PODIUM_RED_RECEPTION TO WS ENTRY 1-DOOR NEW___OutDirection":            "Reception Area",
  "APAC_IN_PUN_PODIUM_RED_RECREATION AREA FIRE EXIT 1-DOOR NEW___InDirection":         "Red Zone",
  "APAC_IN_PUN_PODIUM_RED_RECREATION AREA FIRE EXIT 1-DOOR NEW___OutDirection":        "East Outdoor Area",

  // Podium / Yellow
  "APAC_IN_PUN_PODIUM_ST2 DOOR 2 (YELLOW)___InDirection":                              "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_MDF RESTRICTED DOOR___InDirection":                       "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_IT STORE ROOM-DOOR RESTRICTED DOOR___InDirection":        "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_REPRO STORE-DOOR RESTRICTED DOOR___InDirection":           "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_CONTROL PANEL ROOM-DOOR RESTRICTED DOOR___InDirection":   "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_PREACTION ROOM-DOOR RESTRICTED DOOR___InDirection":        "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_TESTING LAB-DOOR RESTRICTED DOOR___InDirection":           "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_RECEPTION ENTRY-DOOR___InDirection":                       "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_RECEPTION ENTRY-DOOR___OutDirection":                      "Reception Area",
  "APAC_IN_PUN_PODIUM_YELLOW_MAIN LIFT LOBBY-DOOR NEW___InDirection":                   "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_MAIN LIFT LOBBY-DOOR NEW___OutDirection":                  "Out of office",
  "APAC_IN_PUN_PODIUM_ST 1 DOOR 2 (YELLOW)___InDirection":                              "Yellow Zone",
  "APAC_IN_PUN_PODIUM_ST 1 DOOR 2 (YELLOW)___OutDirection":                             "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_FIRE EXIT 1-DOOR NEW___InDirection":                       "Yellow Zone",
  "APAC_IN_PUN_PODIUM_YELLOW_FIRE EXIT 1-DOOR NEW___OutDirection":                      "East Outdoor Area",

  // Podium / Green
  "APAC_IN_PUN_PODIUM_GREEN-_IDF ROOM 1-RESTRICTED DOOR___InDirection":                "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN_UPS ENTRY 1-DOOR RESTRICTED DOOR___InDirection":            "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN_UPS ENTRY 2-DOOR RESTRICTED DOOR___InDirection":            "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN_LOCKER HR STORE 3-DOOR RESTRICTED DOOR___InDirection":      "Green Zone",
  "APAC_IN_PUN_PODIUM_ST4 DOOR 2 (GREEN)___InDirection":                                "Green Zone",
   "APAC_IN_PUN_PODIUM_ST4 DOOR 2 (GREEN)___OutDirection":                               "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN-MAIN LIFT LOBBY-DOOR___InDirection":                        "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN-MAIN LIFT LOBBY-DOOR___OutDirection":                       "East Outdoor Area",
  "APAC_IN_PUN_PODIUM_ST3 DOOR 2 (GREEN)___InDirection":                                "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN_RECEPTION ENTRY-DOOR___InDirection":                        "Green Zone",
  "APAC_IN_PUN_PODIUM_GREEN_RECEPTION ENTRY-DOOR___OutDirection":                       "Reception Area",

  // Podium / Orange
  "APAC_IN_PUN_PODIUM_ST4 DOOR 1 (ORANGE)___InDirection":                               "Orange Zone",
  "APAC_IN_PUN_PODIUM_ST4 DOOR 1 (ORANGE)___OutDirection":                               "Orange Zone",
  "APAC_IN_PUN_PODIUM_ORANGE_RECEPTION ENTRY-DOOR___InDirection":                      "Orange Zone",
  "APAC_IN_PUN_PODIUM_ORANGE_RECEPTION ENTRY-DOOR___OutDirection":                     "Reception Area",
  "APAC_IN_PUN_PODIUM_ST3_DOOR 1 (ORANGE)___InDirection":                              "Orange Zone",

  "APAC_IN_PUN_PODIUM_ORANGE_MAIN LIFT LOBBY-DOOR___InDirection":                       "Orange Zone",
  "APAC_IN_PUN_PODIUM_ORANGE_MAIN LIFT LOBBY-DOOR___OutDirection":                      "Green Zone",
  "APAC_IN_PUN_PODIUM_ORANGE-IDF ROOM 3-RESTRICTED DOOR___InDirection":                "Orange Zone",
  "APAC_IN_PUN_PODIUM_ORANGE_KITCHENETTE FIRE EXIT-DOOR NEW___InDirection":            "Orange Zone",
  "APAC_IN_PUN_PODIUM_ORANGE_KITCHENETTE FIRE EXIT-DOOR NEW___OutDirection":           "West Outdoor Area",

  // Podium / GSOC door
  "APAC_IN_PUN_PODIUM_GSOC DOOR RESTRICTED DOOR___InDirection":                         "Yellow Zone",

  // Podium / Main Right & Left Entry
  "APAC_IN_PUN_PODIUM_MAIN PODIUM RIGHT ENTRY-DOOR NEW___InDirection":                  "Reception Area",
  "APAC_IN_PUN_PODIUM_MAIN PODIUM RIGHT ENTRY-DOOR NEW___OutDirection":                 "Assembly Area",
  "APAC_IN_PUN_PODIUM_MAIN PODIUM LEFT ENTRY-DOOR NEW___InDirection":                   "Reception Area",
  "APAC_IN_PUN_PODIUM_MAIN PODIUM LEFT ENTRY-DOOR NEW___OutDirection":                  "Assembly Area",

  // Podium / Turnstiles
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 1-DOOR___InDirection":                               "Reception Area",
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 2-DOOR___InDirection":                               "Reception Area",
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 3-DOOR___InDirection":                               "Reception Area",
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 4-DOOR___InDirection":                               "Reception Area",
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 2 -OUT DOOR___OutDirection":                         "Out of office",
  "APAC_IN_PUN-PODIUM_P-1 TURNSTILE 3 -OUT DOOR___OutDirection":                         "Out of office",
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 4 -OUT DOOR___OutDirection":                         "Out of office",
  "APAC_IN_PUN_PODIUM_P-1 TURNSTILE 1-OUT DOOR___OutDirection":                          "Out of office",

  // 2nd-Floor / IDF + UPS/ELEC + Reception‚ÜíWorkstation + LiftLobby‚ÜíReception
  "APAC_IN_PUN_2NDFLR_IDF ROOM_10:05:86 RESTRICTED DOOR___InDirection":                  "2nd Floor, Pune",
  "APAC_IN_PUN_2NDFLR_UPS/ELEC ROOM RESTRICTED DOOR___InDirection":                      "2nd Floor, Pune",
  "APAC_IN_PUN_2NDFLR_RECPTION TO WORKSTATION DOOR___InDirection":                       "2nd Floor, Pune",
  "APAC_IN_PUN_2NDFLR_RECPTION TO WORKSTATION DOOR___OutDirection":                      "Out of office",
  "APAC_IN_PUN_2NDFLR_LIFTLOBBY TO RECEPTION EMTRY DOOR___InDirection":                   "2nd Floor, Pune",
  "APAC_IN_PUN_2NDFLR_LIFTLOBBY TO RECEPTION EMTRY DOOR___OutDirection":                  "2nd Floor, Pune",

  // Tower B
  "APAC_IN_PUN_TOWER B_MAIN RECEPTION DOOR___InDirection":                               "Tower B",
  "APAC_IN_PUN_TOWER B_MAIN RECEPTION DOOR___OutDirection":                              "Out of office",
  "APAC_IN_PUN_TOWER B_LIFT LOBBY DOOR___InDirection":                                   "Tower B",
  "APAC_IN_PUN_TOWER B_LIFT LOBBY DOOR___OutDirection":                                  "Out of office",
  "APAC_IN_PUN_TOWER B_ST6_GYM SIDE DOOR___InDirection":                                 "Tower B",
  "APAC_IN_PUN_TOWER B_ST6_GYM SIDE DOOR___OutDirection":                                "Tower B",
  "APAC_IN_PUN_TOWER B_ST6_WKS SIDE DOOR___InDirection":                                 "Tower B",
  "APAC_IN_PUN_TOWER B_ST6_WKS SIDE DOOR___OutDirection":                                "Tower B",
  "APAC_IN_PUN_TOWER B_ST5_KAPIL DEV DOOR___InDirection":                                "Tower B",
  "APAC_IN_PUN_TOWER B_ST5_KAPIL DEV DOOR___OutDirection":                               "Tower B",
  "APAC_IN_PUN_TOWER B_ST5_WKS SIDE DOOR___InDirection":                                 "Tower B",
  "APAC_IN_PUN_TOWER B_ST5_WKS SIDE DOOR___OutDirection":                                "Tower B",
  "APAC_IN_PUN_TOWER B_RECEPTION LEFT DOOR___InDirection":                               "Tower B",
  "APAC_IN_PUN_TOWER B_RECEPTION LEFT DOOR___OutDirection":                              "Tower B",
  "APAC_IN_PUN_TOWER B_RECEPTION RIGHT DOOR___InDirection":                              "Tower B",
  "APAC_IN_PUN_TOWER B_RECEPTION RIGHT DOOR___OutDirection":                             "Tower B",
  "APAC_IN_PUN_TOWER B_IBMS ROOM___InDirection":                                         "Tower B",
  "APAC_IN_PUN_TOWER B_UPS ROOM___InDirection":                                          "Tower B",
  "APAC_IN_PUN_TOWER B_MDF ROOM___InDirection":                                          "Tower B",
  "APAC_IN_PUN_TOWER B_PAC ROOM___InDirection":                                          "Tower B",
  "APAC_IN_PUN_TOWER B_IT STORE ROOM___InDirection":                                    "Tower B",
  "APAC_IN_PUN_TOWER B_GYM ROOM___InDirection":                                          "Tower B GYM",
  "APAC_IN_PUN_TOWER B_GYM ROOM___OutDirection":                                         "Tower B GYM",
  "APAC_IN_PUN_TOWER B_SITE OPS STORE___InDirection":                    "Tower B",
  "APAC_IN_PUN_TOWER B_INNOVATION CENTER___InDirection" :   "Tower B",
  "APAC_IN_PUN_TOWER B_INNOVATION CENTER___OutDirection":   "Tower B",

   "APAC_IN_PUN_TOWER B_MOBILE LAB___InDirection":    "Tower B",
   "APAC_IN_PUN_TOWER B_MOBILE LAB___OutDirection":    "Tower B",
  "APAC_IN_PUN_TOWER B_CEC DOOR___InDirection":           "Tower B",
  "APAC_IN_PUN_TOWER B_CEC DOOR___OutDirection":          "Tower B",
};

module.exports = doorZoneMap;




8**********************************************************
8**********************************************************

8**********************************************************
8**********************************************************




// src/App.js
import React, {
  useEffect,
  useState,
  useRef,
  useCallback,
  lazy,
  Suspense
} from 'react';
import {
  Container,
  Navbar,
  Nav,
  Button,
  InputGroup,
  FormControl,
  Spinner
} from 'react-bootstrap';
import { BrowserRouter, Routes, Route, Link, useLocation } from 'react-router-dom';
import { FaSun, FaBuilding } from 'react-icons/fa';

import { FaBuildingCircleCheck } from "react-icons/fa6";
import { MdAddAlert } from "react-icons/md";
import OverlayTrigger from "react-bootstrap/OverlayTrigger";
import Tooltip from "react-bootstrap/Tooltip";
import EmployeeTravelDashboard from "./pages/EmployeeTravelDashboard";
import { GiAirplaneDeparture } from "react-icons/gi";
import './App.css';

// Lazy load pages
const DashboardHome = lazy(() => import('./pages/DashboardHome'));
const ErtPage = lazy(() => import('./pages/ErtPage'));
const ZoneDetailsTable = lazy(() => import('./components/ZoneDetailsTable'));
const CompanySummary = lazy(() => import('./components/CompanySummary'));

// const DashboardPage = lazy(() => import('./pages/DashboardPage'));
// -----------------------------
// Error Banner
// -----------------------------
function ErrorBanner({ status }) {
  if (status === 'open') return null;

  let message = '';
  if (status === 'connecting') {
    message = 'Connecting to live data...';
  } else if (status === 'error') {
    message = '‚ö†Ô∏è Live data connection lost. Retrying...';
  }

  return (
    <div style={{
      background: status === 'error' ? '#b00020' : '#444',
      color: '#fff',
      padding: '8px 16px',
      borderLeft: status === 'error' ? '4px solid #ff9800' : '4px solid #2196f3',
      marginBottom: '8px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center'
    }}>
      <span>{message}</span>
      {status === 'error' && (
        <button
          className="btn btn-sm btn-outline-light"
          onClick={() => window.location.reload()}
        >
          Retry
        </button>
      )}
    </div>
  );
}

// -----------------------------
// TimeTravelControl
// -----------------------------
function TimeTravelControl({ currentTimestamp, onApply, onLive, loading }) {
  const [local, setLocal] = useState(currentTimestamp ? isoToInput(currentTimestamp) : '');

  useEffect(() => {
    setLocal(currentTimestamp ? isoToInput(currentTimestamp) : '');
  }, [currentTimestamp]);

  const handleApply = useCallback(() => {
    if (!local) return;
    const selected = new Date(local);
    if (selected > new Date()) {
      return window.alert("Please select a valid time (cannot be future)");
    }
    const [datePart, timePart] = local.split('T');
    onApply(datePart, timePart);
  }, [local, onApply]);

  const handleLive = useCallback(() => {
    setLocal('');
    onLive();
  }, [onLive]);

  return (
    <div style={{ display: 'flex', gap: 8, alignItems: 'center', minWidth: 340 }}>
      <InputGroup>
        <FormControl
          type="datetime-local"
          value={local}
          onChange={e => setLocal(e.target.value)}
          placeholder="Select date & time"
        />
      </InputGroup>
      <div style={{ display: 'flex', gap: 6 }}>
        <Button variant="outline-warning" onClick={handleApply} disabled={loading || !local}>
          {loading ? <><Spinner animation="border" size="sm" /> Applying</> : 'Apply'}
        </Button>
        <Button variant="warning" onClick={handleLive} disabled={loading}>Live</Button>
      </div>
    </div>
  );
}

function pad(n) { return String(n).padStart(2, '0'); }
function isoToInput(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// -----------------------------
// ZoneDetailsPage
// -----------------------------
const ZoneDetailsPage = React.memo(function ZoneDetailsPage({ detailsData }) {
  const [searchTerm, setSearchTerm] = useState('');
  return (
    <>
      <div className="d-flex justify-content-between align-items-center mb-2" style={{ flexWrap: 'wrap', gap: '0.5rem' }}>
        <Link to="/" className="btn btn-secondary">‚Üê Back to Dashboard</Link>
        <input
          type="text"
          placeholder="Search employee..."
          value={searchTerm}
          onChange={e => setSearchTerm(e.target.value)}
          style={{ flexGrow: 1, maxWidth: 300, padding: '0.4rem 0.8rem', fontSize: '1rem', borderRadius: 4, border: '1px solid #ccc' }}
        />
      </div>
      <Suspense fallback={<div>Loading details‚Ä¶</div>}>
        <ZoneDetailsTable data={detailsData} searchTerm={searchTerm} />
      </Suspense>
    </>
  );
});

// -----------------------------
// Main App
// -----------------------------
function App() {
  const esRef = useRef(null);
  const sseBufferRef = useRef(null);
  const sseFlushScheduledRef = useRef(false);
  const lastSeenRef = useRef(Date.now());

  const location = useLocation();
  const headerText = location.pathname === '/ert'
    ? 'Emergency Response Team ‚Äî Western Union Pune'
    : 'Live Occupancy ‚Äî Western Union Pune';

  const API_BASE = process.env.REACT_APP_API_BASE_URL
    || (process.env.NODE_ENV === 'development' ? 'http://localhost:5000' : window.location.origin);
  const API_ORIGIN = API_BASE.replace(/\/$/, '');

  const [liveData, setLiveData] = useState({
    summary: [], details: {}, floorBreakdown: [], zoneBreakdown: [], personnelBreakdown: [],
    totalVisitedToday: 0, personnelSummary: { employees: 0, contractors: 0 },
    visitedToday: { employees: 0, contractors: 0, total: 0 }, ertStatus: {}
  });

  const [timeTravelMode, setTimeTravelMode] = useState(false);
  const [timeTravelTimestamp, setTimeTravelTimestamp] = useState(null);
  const [timeTravelLoading, setTimeTravelLoading] = useState(false);

  const [connectionStatus, setConnectionStatus] = useState('connecting'); // connecting | open | error
  const [dashboardLoading, setDashboardLoading] = useState(true);

  // ------------------ setPayload ------------------
  const setPayload = useCallback(p => {
    if (!p || typeof p !== 'object') return;
    const safe = {
      summary: Array.isArray(p.summary) ? p.summary : [],
      details: p.details && typeof p.details === 'object' ? p.details : {},
      floorBreakdown: Array.isArray(p.floorBreakdown) ? p.floorBreakdown : [],
      zoneBreakdown: Array.isArray(p.zoneBreakdown) ? p.zoneBreakdown : [],
      personnelBreakdown: Array.isArray(p.personnelBreakdown) ? p.personnelBreakdown : [],
      totalVisitedToday: typeof p.totalVisitedToday === 'number' ? p.totalVisitedToday : 0,
      personnelSummary: p.personnelSummary || { employees: 0, contractors: 0 },
      visitedToday: p.visitedToday || { employees: 0, contractors: 0, total: 0 },
      ertStatus: p.ertStatus || {}
    };
    setLiveData(prev => ({ ...prev, ...safe }));
    setDashboardLoading(false); // ‚úÖ stop spinner when data arrives
  }, []);

  // ------------------ Bootstrap Fetch ------------------
  useEffect(() => {
    const fetchBootstrap = async () => {
      try {
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD
        const timeStr = now.toTimeString().slice(0, 8); // HH:MM:SS

        const resp = await fetch(
          `${API_ORIGIN}/api/occupancy-at-time-pune?date=${encodeURIComponent(dateStr)}&time=${encodeURIComponent(timeStr)}`
        );
        if (resp.ok) {
          const p = await resp.json();
          setPayload(p);
        }
      } catch (err) {
        console.error("Bootstrap fetch failed", err);
      }
    };

    fetchBootstrap();
  }, [API_ORIGIN, setPayload]);

  // ------------------ SSE Live Updates ------------------
  useEffect(() => {
    if (location.pathname === "/travel-dashboard") return;
    if (timeTravelMode) {
      esRef.current?.close();
      esRef.current = null;
      return;
    }

    const esUrl = `${API_ORIGIN}/api/live-occupancy`;
    const es = new EventSource(esUrl);
    esRef.current = es;

    es.onopen = () => setConnectionStatus('open');

    es.onmessage = e => {
      try {
        const p = JSON.parse(e.data);
        lastSeenRef.current = Date.now();
        sseBufferRef.current = p;

        if (!sseFlushScheduledRef.current) {
          sseFlushScheduledRef.current = true;
          setTimeout(() => {
            setPayload(sseBufferRef.current);
            sseFlushScheduledRef.current = false;
          }, 500);
        }
      } catch (err) {
        console.error('[SSE] parse error', err);
        setConnectionStatus('error');
      }
    };

    es.onerror = err => {
      console.error('[SSE] error', err);
      setConnectionStatus('error');
    };

    return () => es.close();
  }, [timeTravelMode, API_ORIGIN, setPayload, location.pathname]);

  // ------------------ Time Travel ------------------
  const fetchSnapshot = useCallback(async (dateStr, timeStr) => {
    setTimeTravelLoading(true);
    const safeTime = timeStr.length === 5 ? `${timeStr}:00` : timeStr;
    const url = `${API_ORIGIN}/api/occupancy-at-time-pune?date=${encodeURIComponent(dateStr)}&time=${encodeURIComponent(safeTime)}`;
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
      const p = await resp.json();
      setPayload(p);
      setTimeTravelMode(true);
      setTimeTravelTimestamp(p?.asOfLocal || `${dateStr} ${safeTime}`);
    } catch (err) {
      console.error(err);
    } finally {
      setTimeTravelLoading(false);
    }
  }, [API_ORIGIN, setPayload]);

  const clearTimeTravel = useCallback(async () => {
    setTimeTravelLoading(true);
    try {
      setTimeTravelMode(false);
      setTimeTravelTimestamp(null);

      // ‚úÖ fetch snapshot with current time
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10);
      const timeStr = now.toTimeString().slice(0, 8);

      const resp = await fetch(
        `${API_ORIGIN}/api/occupancy-at-time-pune?date=${encodeURIComponent(dateStr)}&time=${encodeURIComponent(timeStr)}`
      );
      if (resp.ok) {
        const p = await resp.json();
        setPayload(p);
      }
    } finally {
      setTimeTravelLoading(false);
    }
  }, [API_ORIGIN, setPayload]);


  const hideNavbar = location.pathname === "/travel-dashboard";
  const isTravelDashboard = location.pathname === "/travel-dashboard";
  const showTravelDashboardIcon = false;

  // ------------------ Render ------------------
  return (
    <>

  

      {!hideNavbar && (
        <Navbar bg="dark" variant="dark" expand="lg" className="px-3">
          <Navbar.Brand as={Link} to="/" className="wu-brand">{headerText}</Navbar.Brand>
          <Navbar.Toggle aria-controls="main-navbar" />
          <Navbar.Collapse id="main-navbar">
            <Nav className="ms-auto align-items-center gap-2">
              <div className="time-travel-wrapper me-2">
                <TimeTravelControl
                  currentTimestamp={timeTravelTimestamp}
                  onApply={fetchSnapshot}
                  onLive={clearTimeTravel}
                  loading={timeTravelLoading}
                />
              </div>

              <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">Dashboard</Tooltip>}>
                <Nav.Link as={Link} to="/" className="nav-item-infographic">
                  <i className="bi bi-house"></i>
                </Nav.Link>
              </OverlayTrigger>

              <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">Live Details Page</Tooltip>}>
                <Nav.Link as={Link} to="/details" className="nav-item-infographic">
                  <i className="fa-solid fa-calendar-day"></i>
                </Nav.Link>
              </OverlayTrigger>

              <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">ERT Overview</Tooltip>}>
                <Nav.Link as={Link} to="/ert" className="nav-item-infographic">
                  <MdAddAlert className='nav-item-new' />
                </Nav.Link>
              </OverlayTrigger>

              <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">Company Summary</Tooltip>}>
                <Nav.Link as={Link} to="/companysummary" className="nav-item-infographic">
                  <FaBuildingCircleCheck className='nav-item-new' />
                </Nav.Link>
              </OverlayTrigger>

              {/* {location.pathname !== "/" && (
                <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">Travel Dashboard</Tooltip>}>
                  <Nav.Link
                    onClick={() => window.open("/travel-dashboard", "_blank", "noopener,noreferrer")}
                    className="nav-item-infographic"
                  >
                    <i className="fa-solid fa-plane fa-fade"></i>
                  </Nav.Link>
                </OverlayTrigger>
              )} */}


              {showTravelDashboardIcon && (
  <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">Travel Dashboard</Tooltip>}>
    <Nav.Link
      onClick={() => window.open("/travel-dashboard", "_blank", "noopener,noreferrer")}
      className="nav-item-infographic"
    >
      <i className="fa-solid fa-plane fa-fade"></i>
    </Nav.Link>
  </OverlayTrigger>
)}

              <OverlayTrigger placement="bottom" overlay={<Tooltip id="tooltip-dashboard">History</Tooltip>}>
                <Nav.Link href="http://10.199.22.57:3000/partition/Pune/history" className="nav-item-infographic">
                  <i className="bi bi-clock-history"></i>
                </Nav.Link>
              </OverlayTrigger>
            </Nav>
          </Navbar.Collapse>
        </Navbar>
      )}

      <Container fluid className="mt-2">
        {timeTravelMode && (
          <div style={{ background: '#434d44', color: '#FFF', padding: '8px 16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderLeft: '4px solid rgb(0, 255, 21)', marginBottom: 8 }}>
            <div>Viewing snapshot: <strong>{new Date(timeTravelTimestamp).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}</strong></div>
            <div>
              <button className="btn btn-sm btn-outline-warning" onClick={clearTimeTravel} disabled={timeTravelLoading}>Return to Live</button>
            </div>
          </div>
        )}

        {/* Error UI */}
        {/* <ErrorBanner status={connectionStatus} /> */}
        {location.pathname !== "/travel-dashboard" && (
          <ErrorBanner status={connectionStatus} />
        )}

        {dashboardLoading ? (
          <div className="d-flex justify-content-center align-items-center" style={{ minHeight: '60vh' }}>
            <Spinner animation="border" role="status" variant="warning" />
            <span className="ms-2" style={{ color: '#FFC72C' }}>Loading live occupancy‚Ä¶</span>
          </div>
        ) : (
          <Suspense fallback={<div style={{ color: '#FFC72C' }}>Loading page‚Ä¶</div>}>
            <Routes>
              <Route path="/" element={
                <DashboardHome
                  summaryData={liveData.summary}
                  detailsData={liveData.details}
                  floorData={liveData.floorBreakdown}
                  zoneBreakdown={liveData.zoneBreakdown}
                  personnelBreakdown={liveData.personnelBreakdown}
                  totalVisitedToday={liveData.totalVisitedToday}
                  personnelSummary={liveData.personnelSummary}
                  visitedToday={liveData.visitedToday}
                  ertStatus={liveData.ertStatus}
                />
              } />
              <Route path="/details" element={<ZoneDetailsPage detailsData={liveData.details} />} />
              <Route path="/ert" element={<ErtPage ertStatus={liveData.ertStatus} />} />

              <Route path="/companysummary" element={
                <CompanySummary
                  detailsData={liveData.details}
                  personnelBreakdown={liveData.personnelBreakdown}
                  zoneBreakdown={liveData.zoneBreakdown}
                />

              } />

              <Route path="/travel-dashboard" element={<EmployeeTravelDashboard />} />


            </Routes>

          </Suspense>
        )}
      </Container>
    </>
  );
}

export default function WrappedApp() {
  return (
    <BrowserRouter future={{ v7_relativeSplatPath: true }}>
      <div className="dark-theme">
        <App />
      </div>
    </BrowserRouter>
  );
}





********************************************
********************************************






// C:\Users\W0024618\Desktop\swipeData\client\src\components\CompanySummary.jsx
import React, { useState, useMemo, useEffect } from "react";
import { Container, Row, Col, Card, Table, Badge, Modal, Button, Nav, Header } from "react-bootstrap";
import { FaBuilding, FaUsers, FaChartPie, FaHouse, FaBars } from 'react-icons/fa6';
import XLSX from "xlsx-js-style";
import { saveAs } from "file-saver";
import ExcelJS from "exceljs";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";

const CompanySummary = ({ detailsData = {} }) => {
    const [selectedBuilding, setSelectedBuilding] = useState("all");
    const [showModal, setShowModal] = useState(false);
    const [modalTitle, setModalTitle] = useState("");
    const [modalRows, setModalRows] = useState([]);
    const [activeTab, setActiveTab] = useState("companyAnalytics");
    const [currentTime, setCurrentTime] = useState(new Date());
    const [sidebarOpen, setSidebarOpen] = useState(true);

    // Clock
    useEffect(() => {
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
    }, []);




    const getBuildingFromZone = (zone) => {
        if (!zone) return null;
        const z = String(zone).toLowerCase();
        if (z.includes("red zone") || z.includes("yellow zone") || z.includes("green zone") || z.includes("reception") || z.includes("reception area") || z.includes("orange zone")
            || z.includes("east outdoor area") || z.includes("west outdoor area") || z.includes("assembly area")) return "Podium Floor";
        if (z.includes("2nd")) return "2nd Floor";
        if (z.includes("tower b")) return "Tower B";
        return null;
    };
    //   || z.includes(" "))

    const normalizeCompany = (raw) => {
        if (!raw) return 'Unknown';
        const orig = String(raw).trim();
        const s = orig.toLowerCase().replace(/[.,()\/\-]/g, ' ').replace(/\s+/g, ' ').trim();
        if (/\bpoona\b/.test(s) || /\bpoona security\b/.test(s)) return 'Poona Security India Pvt Ltd';
        if (/\bwestern union\b/.test(s) || /\bwu\b/.test(s)) return 'Western Union';
        if (/\bvedant\b/.test(s)) return 'Vedant Enterprises Pvt. Ltd';
        if (/\bosource\b/.test(s)) return 'Osource India Pvt Ltd';
        if (/\bcbre\b/.test(s)) return 'CBRE';
        return orig || 'Unknown';
    };

    const getCanonicalCompany = (r) => {
        const rawCompany = (r.CompanyName || '').toString().trim();
        const pt = (r.PersonnelType || '').toString().trim().toLowerCase();
        const s = rawCompany.toLowerCase();
        if (s && /\bcbre\b/.test(s) && (/\bclr\b/.test(s) || /\bfacilit/i.test(s))) return 'CLR Facility Services Pvt.Ltd.';
        if (!rawCompany) {
            if (pt.includes('contractor')) return 'CBRE';
            if (pt.includes('property') || pt.includes('management')) return 'CLR Facility Services Pvt.Ltd.';
            if (pt === 'employee' || pt === 'Terminated Personnel') return 'Western Union';
            if (pt.includes('visitor')) return 'Visitor';
            if (pt.includes('temp')) return 'Temp Badge';
            return 'Unknown';
        }
        return normalizeCompany(rawCompany);
    };
    const exportToExcel = () => {
        const wb = XLSX.utils.book_new();

        // Extract table data
        const table = document.getElementById("companyTable");
        const ws = XLSX.utils.table_to_sheet(table, { raw: true });

        // Get range of data
        const range = XLSX.utils.decode_range(ws["!ref"]);

        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                if (!ws[cellAddress]) continue;

                // Default style (all cells)
                ws[cellAddress].s = {
                    font: { name: "Calibri", sz: 11 },
                    border: {
                        top: { style: "thin", color: { rgb: "DDDDDD" } },
                        bottom: { style: "thin", color: { rgb: "DDDDDD" } },
                        left: { style: "thin", color: { rgb: "DDDDDD" } },
                        right: { style: "thin", color: { rgb: "DDDDDD" } },
                    },
                    alignment: { horizontal: "center", vertical: "center" }
                };

                // Header style (Row 0)
                if (R === 0) {
                    ws[cellAddress].s = {
                        ...ws[cellAddress].s,
                        font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
                        fill: { type: "pattern", pattern: "solid", fgColor: { rgb: "2965CC" } }
                    };
                }

                // Totals row style (last row)
                if (R === range.e.r) {
                    ws[cellAddress].s = {
                        ...ws[cellAddress].s,
                        font: { bold: true, color: { rgb: "000000" }, sz: 12 },
                        fill: { type: "pattern", pattern: "solid", fgColor: { rgb: "AACEF2" } }
                    };
                }

                // Alternate row shading
                if (R > 0 && R < range.e.r && R % 2 === 0) {
                    ws[cellAddress].s = {
                        ...ws[cellAddress].s,
                        fill: { type: "pattern", pattern: "solid", fgColor: { rgb: "F2F2F2" } }
                    };
                }

                // Company name column ‚Üí left align
                if (C === 1 && R > 0) {
                    ws[cellAddress].s.alignment = { horizontal: "left", vertical: "center" };
                }
            }
        }

        // Auto column widths
        const colWidths = [];
        for (let C = range.s.c; C <= range.e.c; ++C) {
            let maxLen = 10;
            for (let R = range.s.r; R <= range.e.r; ++R) {
                const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                const value = ws[cellAddress]?.v ? ws[cellAddress].v.toString() : "";
                if (value.length > maxLen) maxLen = value.length;
            }
            colWidths.push({ wch: maxLen + 2 });
        }
        ws["!cols"] = colWidths;

        // Add sheet and save
        XLSX.utils.book_append_sheet(wb, ws, "Company Distribution");
        const excelBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array", cellStyles: true });
        const data = new Blob([excelBuffer], { type: "application/octet-stream" });
        saveAs(data, "Company_Distribution.xlsx");
    };




    const exportModalTableToExcel = async () => {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("Employee Details");

        // üîπ Build header row
        const headers = ["Sr", ...(modalRows[0]?.company ? ["Company Name"] : []), "Name", "Employee ID", "Personnel Type", "Zone"];
        const headerRow = worksheet.addRow(headers);

        // Style header
        headerRow.eachCell((cell) => {
            cell.fill = {
                type: "pattern",
                pattern: "solid",
                fgColor: { argb: "2965CC" },
            };
            cell.font = { bold: true, color: { argb: "FFFFFF" } };
            cell.alignment = { horizontal: "center", vertical: "middle" };
            cell.border = {
                top: { style: "thin" },
                left: { style: "thin" },
                bottom: { style: "thin" },
                right: { style: "thin" },
            };
        });

        // üîπ Add table rows
        modalRows.forEach((row, idx) => {
            const rowData = [
                row.idx,
                ...(row.company ? [row.company] : []),
                row.name,
                row.employeeId || "-",
                row.personnelType || "-",
                row.zone || "-",
            ];

            const newRow = worksheet.addRow(rowData);

            newRow.eachCell((cell) => {
                cell.alignment = { horizontal: "center", vertical: "middle" };
                cell.border = {
                    top: { style: "thin" },
                    left: { style: "thin" },
                    bottom: { style: "thin" },
                    right: { style: "thin" },
                };
                // Alternate row shading
                if (idx % 2 === 0) {
                    cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "F2F2F2" } };
                }
            });
        });

        // üîπ Auto-fit columns
        worksheet.columns.forEach((col) => {
            let maxLength = 10;
            col.eachCell({ includeEmpty: true }, (cell) => {
                const val = cell.value ? cell.value.toString() : "";
                if (val.length > maxLength) maxLength = val.length;
            });
            col.width = maxLength + 2;
        });

        // Save Excel
        const buf = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buf]), "Employee_Details.xlsx");
    };


    const companyData = useMemo(() => {
        const companies = {};
        let totalCount = 0;
        const buildingTotals = { "Podium Floor": 0, "2nd Floor": 0, "Tower B": 0 };

        Object.values(detailsData || {}).forEach((zoneEmployees) => {
            if (Array.isArray(zoneEmployees)) {
                zoneEmployees.forEach((employee) => {
                    const companyName = getCanonicalCompany(employee);
                    const building = getBuildingFromZone(employee?.zone);
                    if (!building) return;

                    if (!companies[companyName]) {
                        companies[companyName] = {
                            name: companyName,
                            total: 0,
                            byBuilding: { "Podium Floor": 0, "2nd Floor": 0, "Tower B": 0 },
                            employees: [],
                            locations: new Set()
                        };
                    }

                    companies[companyName].total++;
                    companies[companyName].byBuilding[building]++;
                    companies[companyName].employees.push(employee);
                    if (employee?.PrimaryLocation) companies[companyName].locations.add(employee.PrimaryLocation);

                    totalCount++;
                    buildingTotals[building]++;
                });
            }
        });

        const companyArray = Object.values(companies)
            .map((company) => ({
                ...company,
                locations: Array.from(company.locations || []),
                percentage: totalCount > 0 ? ((company.total / totalCount) * 100).toFixed(1) : "0.0"
            }))
            .sort((a, b) => (b.total || 0) - (a.total || 0));

        return { companies: companyArray, totalCount, buildingTotals };
    }, [detailsData]);

    const filteredCompanies = useMemo(() => {
        if (selectedBuilding === "all") return companyData?.companies || [];
        return companyData?.companies.filter((c) => (c.byBuilding?.[selectedBuilding] || 0) > 0);
    }, [companyData?.companies, selectedBuilding]);


    const openModalWithRows = (title, rows = []) => {
        setModalTitle(title || "");
        setModalRows(rows || []);
        setShowModal(true);
    };

    const handleCompanyClick = (company) => {
        const rows = (company?.employees || []).map((r, i) => ({
            idx: i + 1,
            name: r?.ObjectName1 || r?.Name || "‚Äî",
            employeeId: r?.EmployeeID || "",
            cardNumber: r?.CardNumber || "",
            personnelType: r?.PersonnelType || "",
            primaryLocation: r?.PrimaryLocation || "",
            zone: r?.zone || ""
        }));
        openModalWithRows(company?.name || "Company Details", rows);
    };

    const handleBuildingClick = (buildingName) => {
        const allEmployees = [];
        (companyData?.companies || []).forEach((c) => {
            (c.employees || []).forEach((r) => {
                const b = getBuildingFromZone(r?.zone);
                if (b === buildingName) {
                    allEmployees.push({
                        name: r?.ObjectName1 || r?.Name || "‚Äî",
                        employeeId: r?.EmployeeID || "",
                        cardNumber: r?.CardNumber || "",
                        personnelType: r?.PersonnelType || "",
                        primaryLocation: r?.PrimaryLocation || "",
                        company: r?.CompanyName || "Unknown Company",
                        zone: r?.zone || ""
                    });
                }
            });
        });

        allEmployees.sort((a, b) => {
            if ((a.company || "") !== (b.company || "")) return (a.company || "").localeCompare(b.company || "");
            return (a.name || "").localeCompare(b.name || "");
        });

        const rows = allEmployees.map((r, i) => ({ idx: i + 1, ...r }));
        openModalWithRows(`${buildingName} ‚Äî Occupants`, rows);
    };

    const handleCompanyBuildingClick = (company, buildingName) => {
        const rows = (company?.employees || [])
            .filter((r) => getBuildingFromZone(r?.zone) === buildingName)
            .map((r, i) => ({
                idx: i + 1,
                name: r?.ObjectName1 || r?.Name || "‚Äî",
                employeeId: r?.EmployeeID || "",
                cardNumber: r?.CardNumber || "",
                personnelType: r?.PersonnelType || "",
                primaryLocation: r?.PrimaryLocation || "",
                zone: r?.zone || ""
            }));

        openModalWithRows(`${company?.name || "Company"} ‚Äî ${buildingName}`, rows);
    };



    const companyShortNames = {
        "Western Union": "WU",
        "Visitor": "Visitor",
        "CLR Facility Services Pvt.Ltd.": "CLR",
        "Poona Security India Pvt Ltd": "PSI",
        "CBRE": "CBRE",
        "Osource India Pvt Ltd": "Osource",
        "Temp Badge": "Temp Badge",
        "Vedant Enterprises Pvt. Ltd": "Vedant",
        "Tea Point": "Tea Point"
    };


    // const chartData = useMemo(() => {
    //     return (companyData?.companies || []).map((c, idx) => ({
    //         name: c.name,
    //         podium: c.byBuilding["Podium Floor"] || 0,
    //         second: c.byBuilding["2nd Floor"] || 0,
    //         towerB: c.byBuilding["Tower B"] || 0,
    //         total: c.total || 0,
    //     }));
    // }, [companyData]);


    const chartData = useMemo(() => {
        return (companyData?.companies || []).map((c) => ({
            name: companyShortNames[c.name] || c.name,  // <-- short name
            podium: c.byBuilding["Podium Floor"] || 0,
            second: c.byBuilding["2nd Floor"] || 0,
            towerB: c.byBuilding["Tower B"] || 0,
            total: c.total || 0,
        }));
    }, [companyData]);

    const renderTabContent = () => {
        if (activeTab === "companyAnalytics") {
            return (
                <>
                    <Row className="mb-2">
                        {["Podium Floor", "2nd Floor", "Tower B"].map((floor, idx) => (
                            <Col md={4} key={floor} className="mb-2">
                                <Card
                                    className="h-100 shadow-sm border-0 cursor-pointer"
                                    // style={{ background: `linear-gradient(135deg, #3a8dff, #6cc1ff)`, color: "#fff", transition: "transform 0.2s" }}
                                    style={{ background: `linear-gradient(135deg, #144a79ff, #2475aeff)`, color: "#fff", transition: "transform 0.2s", cursor: 'pointer' }}
                                    onClick={() => handleBuildingClick(floor)}
                                    onMouseOver={e => e.currentTarget.style.transform = "scale(1.05)"}
                                    onMouseOut={e => e.currentTarget.style.transform = "scale(1)"}
                                >
                                    <Card.Body className="text-center py-3">
                                        <FaUsers className="fs-1 mb-2" />
                                        <h3>{companyData?.buildingTotals?.[floor] || 0}</h3>
                                        <p className="mb-0">{floor} Occupancy</p>
                                    </Card.Body>
                                </Card>
                            </Col>
                        ))}
                    </Row>

                    <Row>
                        <Col>
                            <Card className="shadow-sm border-0">
                                <Card.Body className="p-0">

                                    <div className="table-responsive">
                                        <Table hover className="mb-0" id="companyTable">
                                            <thead style={{ background: "#aacef2" }}>
                                                <tr>
                                                    <th style={{ background: "#2965cc", color: "#FFF" }}>Rank</th>
                                                    <th style={{ background: "#2965cc", color: "#FFF" }}>Company Name</th>
                                                    <th style={{ background: "#2965cc", color: "#FFF" }}>Podium Floor</th>
                                                    <th style={{ background: "#2965cc", color: "#FFF" }}>2nd Floor</th>
                                                    <th style={{ background: "#2965cc", color: "#FFF" }}>Tower B</th>
                                                    <th style={{ background: "#2965cc", color: "#FFF" }}>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(filteredCompanies || []).map((company, index) => (
                                                    <tr key={company?.name || index}>
                                                        <td>
                                                            <Badge bg="light" text="dark">{index + 1}</Badge>
                                                        </td>
                                                        <td
                                                            onClick={() => handleCompanyClick(company)}
                                                            style={{ cursor: "pointer", textDecoration: "underline" }}
                                                        >
                                                            {company?.name}
                                                        </td>
                                                        {["Podium Floor", "2nd Floor", "Tower B"].map((floor) => (
                                                            <td key={floor}>
                                                                {company?.byBuilding?.[floor] > 0 ? (
                                                                    <Badge
                                                                        bg="primary"
                                                                        role="button"
                                                                        style={{ cursor: "pointer" }}
                                                                        onClick={() => handleCompanyBuildingClick(company, floor)}
                                                                    >
                                                                        {company?.byBuilding?.[floor]}
                                                                    </Badge>
                                                                ) : "-"}
                                                            </td>
                                                        ))}
                                                        <td>
                                                            <Badge bg="light" text="dark">{company?.total || 0}</Badge>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot>
                                                <tr className="fw-bold" style={{ background: "#aacef2" }}>
                                                    <td colSpan={2} className="text-end">Totals:</td>
                                                    <td>{companyData?.buildingTotals?.["Podium Floor"] || 0}</td>
                                                    <td>{companyData?.buildingTotals?.["2nd Floor"] || 0}</td>
                                                    <td>{companyData?.buildingTotals?.["Tower B"] || 0}</td>
                                                    <td>{companyData?.totalCount || 0}</td>
                                                </tr>
                                            </tfoot>

                                        </Table>
                                        <div className="d-flex justify-content-between align-items-center" style={{ background: "#FFF" }}>
                                            <h5 className="mb-0"> </h5>
                                            <Button variant="success" onClick={exportToExcel}>
                                                Export to Excel
                                            </Button>
                                        </div>
                                    </div>
                                </Card.Body>
                            </Card>
                        </Col>
                    </Row>

                    <Row className="mb-4">

                        <Col>
                            <Card className="shadow-sm border-0 p-3" style={{ background: "#ffffff" }}>
                                {/* <h5 className="mb-3">Company Occupancy Line Graph</h5> */}
                                {/* 
                                <ResponsiveContainer width="100%" height={400}>
                                    <LineChart
                                        data={chartData}
                                        style={{ backgroundColor: "#f9fafc", borderRadius: "8px", padding: "8px" }}
                                    >
                                        <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                                        <XAxis
                                            dataKey="name"
                                            angle={-30}
                                            textAnchor="end"
                                            height={100}
                                            stroke="#333"
                                        />
                                        <YAxis stroke="#333" />
                                        <Tooltip contentStyle={{ backgroundColor: "#ffffff", border: "1px solid #ddd" }} />
                                        <Legend />
                                        <Line type="monotone" dataKey="podium" stroke="#4a90e2" name="Podium Floor" />
                                        <Line type="monotone" dataKey="second" stroke="#50c878" name="2nd Floor" />
                                        <Line type="monotone" dataKey="towerB" stroke="#f5a623" name="Tower B" />
                                        <Line type="monotone" dataKey="total" stroke="#d0021b" name="Total" />
                                    </LineChart>
                                </ResponsiveContainer> */}


                                <ResponsiveContainer width="100%" height={400}>
                                    <LineChart
                                        data={chartData}
                                        style={{ backgroundColor: "#f9fafc", borderRadius: "8px", padding: "8px" }}
                                    >
                                        <CartesianGrid strokeDasharray="3 3" stroke="#e0e0e0" />
                                        <XAxis
                                            dataKey="name"
                                            angle={0}
                                            textAnchor="middle"
                                            height={50}
                                            stroke="#333"
                                        />
                                        <YAxis stroke="#333" />
                                        <Tooltip contentStyle={{ backgroundColor: "#ffffff", border: "1px solid #ddd" }} />
                                        <Legend />
                                        <Line type="monotone" dataKey="podium" stroke="#4a90e2" name="Podium Floor" />
                                        <Line type="monotone" dataKey="second" stroke="#50c878" name="2nd Floor" />
                                        <Line type="monotone" dataKey="towerB" stroke="#f5a623" name="Tower B" />
                                        <Line type="monotone" dataKey="total" stroke="#d0021b" name="Total" />
                                    </LineChart>
                                </ResponsiveContainer>


                            </Card>
                        </Col>
                    </Row>
                </>
            );
        } else if (activeTab === "futureTab") {
            // return (
            //     <Card className="shadow-sm p-4 border-0">
            //         <h5><FaChartPie className="me-2 text-primary" /> Future Analytics</h5>
            //         <p className="text-secondary">This area is reserved for future analytics and dashboard metrics.</p>
            //     </Card>
            // );
        }
    };
    // f0f4f8
    return (
        <Container fluid style={{ minHeight: "100vh", background: "#e0e8f5ff" }}>
            <Row>
                {/* Sidebar */}
                <Col
                    xs={sidebarOpen ? 2 : 1}
                    className="position-sticky shadow-sm"
                    style={{
                        top: 0,
                        minHeight: "100vh",
                        transition: "width 0.3s",
                        background: "#f8f9fa",
                        padding: "1rem",
                    }}
                >
                    {/* Dashboard Header */}
                    <div className="d-flex justify-content-between align-items-center mb-4 px-2">
                        {sidebarOpen && (
                            <h5 className="mb-0 text-primary d-flex align-items-center">
                                <FaHouse className="me-2" /> Dashboard
                            </h5>
                        )}
                        <FaBars
                            className="cursor-pointer text-secondary"
                            onClick={() => setSidebarOpen(!sidebarOpen)}
                            style={{ fontSize: "1.3rem" }}
                        />
                    </div>

                    {/* Clock Card */}
                    {sidebarOpen && (
                        <Card
                            className="mb-4 shadow-sm"
                            style={{
                                borderRadius: "0.8rem",
                                background: "linear-gradient(90deg, #3a8dff, #6cc1ff)",
                                color: "#fff",
                                textAlign: "center",
                            }}
                        >
                            <Card.Body style={{ padding: "0.1rem" }}>
                                <div style={{ fontSize: "1rem", fontWeight: "600" }}>Current Time</div>
                                <div style={{ fontSize: "1.2rem", fontWeight: "700" }}>
                                    {currentTime.toLocaleTimeString()}
                                </div>
                            </Card.Body>
                        </Card>
                    )}

                    {/* Navigation Sections */}
                    <div className="mb-3">
                        {sidebarOpen && <div className="text-secondary px-2 mb-2 fw-bold small">Analytics</div>}
                        <Nav className="flex-column">
                            <Nav.Link
                                active={activeTab === "companyAnalytics"}
                                onClick={() => setActiveTab("companyAnalytics")}
                                className={`d-flex align-items-center mb-2 px-3 py-2 rounded shadow-sm ${activeTab === "companyAnalytics"
                                    ? "bg-primary text-white fw-bold"
                                    : "text-dark bg-white"
                                    }`}
                                style={{ transition: "all 0.2s" }}
                                onMouseOver={(e) => (e.currentTarget.style.transform = "scale(1.02)")}
                                onMouseOut={(e) => (e.currentTarget.style.transform = "scale(1)")}
                            >
                                <FaBuilding className="me-2" />
                                {sidebarOpen && "Company Analytics"}
                            </Nav.Link>

                            {/* <Nav.Link
                                active={activeTab === "futureTab"}
                                onClick={() => setActiveTab("futureTab")}
                                className={`d-flex align-items-center mb-2 px-3 py-2 rounded shadow-sm ${activeTab === "futureTab"
                                    ? "bg-primary text-white fw-bold"
                                    : "text-dark bg-white"
                                    }`}
                                style={{ transition: "all 0.2s" }}
                                onMouseOver={(e) => (e.currentTarget.style.transform = "scale(1.02)")}
                                onMouseOut={(e) => (e.currentTarget.style.transform = "scale(1)")}
                            >
                                <FaChartPie className="me-2" />
                                {sidebarOpen && "Future Analytics"}
                            </Nav.Link> */}
                        </Nav>
                    </div>
                    {/* Optional Extra Section */}
                    {/* {sidebarOpen && (
                        <div className="mt-auto">
                            <div className="text-secondary px-2 mb-2 fw-bold small">Extras</div>
                            <Nav className="flex-column">
                                <Nav.Link className="d-flex align-items-center mb-2 px-3 py-2 rounded shadow-sm text-dark bg-white">
                                    <FaUsers className="me-2" />
                                    {sidebarOpen && "User Management"}
                                </Nav.Link>
                            </Nav>
                        </div>
                    )} */}

                </Col>

                {/* Main Content */}
                <Col xs={sidebarOpen ? 10 : 11} className="p-2">
                    <h2 className="text-dark mb-4">
                        {activeTab === "companyAnalytics" ? "" : ""}
                    </h2>
                    {renderTabContent()}
                </Col>
            </Row>
            {/* Modal */}
            <Modal show={showModal} onHide={() => setShowModal(false)} size="lg" centered scrollable>
                <Modal.Header closeButton>
                    <Modal.Title>{modalTitle}</Modal.Title>
                </Modal.Header>
                <Modal.Body>
                    {modalRows.length > 0 ? (
                        <div className="table-responsive">
                            <div className="d-flex justify-content-end mb-2">
                                <Button variant="success" onClick={exportModalTableToExcel}>
                                    Export to Excel
                                </Button>
                            </div>
                            <Table striped bordered hover size="sm">
                                <thead>
                                    <tr>
                                        <th>Sr</th>
                                        {modalRows[0].company && <th>Company</th>}
                                        <th>Name</th>
                                        <th>Employee ID</th>
                                        <th>Personnel Type</th>
                                        <th>Zone</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {modalRows.map((r, i) => (
                                        <tr key={`${r.employeeId || r.idx}-${i}`}>
                                            <td>{r.idx}</td>
                                            {r.company && <td>{r.company}</td>}
                                            <td>{r.name}</td>
                                            <td>{r.employeeId || "-"}</td>
                                            <td>{r.personnelType || "-"}</td>
                                            <td>{r.zone || "-"}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </Table>
                        </div>
                    ) : (
                        <div className="text-center text-muted py-4">No records to display.</div>
                    )}
                </Modal.Body>
                <Modal.Footer>
                    <Button variant="secondary" onClick={() => setShowModal(false)}>Close</Button>
                </Modal.Footer>
            </Modal>
        </Container>
    );
};
export default CompanySummary;



